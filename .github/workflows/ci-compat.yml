name: JQuill CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [17, 20, 24, 25]
        build: [maven, gradle]   # Build tool matrix
        mavenVersion: ["3.8.8", "3.9.11"] # Only used if build=maven
        gradleVersion: ["8.3", "8.4"]     # Only used if build=gradle
    name: Java ${{ matrix.java }} + ${{ matrix.build }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Setup Java
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}

      # Setup Maven or Gradle
      - name: Setup Build Tool
        run: |
          if [ "${{ matrix.build }}" == "maven" ]; then
            echo "Using Maven ${{ matrix.mavenVersion }}"
            curl -sL https://archive.apache.org/dist/maven/maven-3/${{ matrix.mavenVersion }}/binaries/apache-maven-${{ matrix.mavenVersion }}-bin.zip -o maven.zip
            unzip maven.zip
            export PATH="$PWD/apache-maven-${{ matrix.mavenVersion }}/bin:$PATH"
          else
            echo "Using Gradle ${{ matrix.gradleVersion }}"
            wget https://services.gradle.org/distributions/gradle-${{ matrix.gradleVersion }}-bin.zip -O gradle.zip
            unzip gradle.zip
            export PATH="$PWD/gradle-${{ matrix.gradleVersion }}/bin:$PATH"
          fi

      # Cache dependencies
      - uses: actions/cache@v3
        with:
          path: |
            ~/.m2/repository
            ~/.gradle
          key: ${{ runner.os }}-build-${{ matrix.build }}-${{ hashFiles('**/pom.xml','**/build.gradle') }}

      # Run build
      - name: Build Project
        run: |
          if [ "${{ matrix.build }}" == "maven" ]; then
            mvn clean install -B
          else
            gradle clean build --console=plain
          fi

      # Record result
      - name: Record result
        id: set-table
        run: |
          # Save the result in a format we can aggregate
          if [ $? -eq 0 ]; then STATUS="✅"; else STATUS="❌"; fi
          echo "table=${{ matrix.java }}|${{ matrix.build }}|$STATUS" >> $GITHUB_OUTPUT

  aggregate:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Collect results
        run: |
          # Create a Markdown table
          echo "| Java | Tool   | Status |" > compat.md
          echo "|------|--------|--------|" >> compat.md

          # Loop over matrix results
          for result in ${{ needs.build.outputs.result-table }}; do
            IFS="|" read java tool status <<< "$result"
            echo "| $java | $tool | $status |" >> compat.md
          done

      - name: Update README
        run: |
          sed -i '/<!-- COMPAT_TABLE_START -->/,/<!-- COMPAT_TABLE_END -->/c\
          <!-- COMPAT_TABLE_START -->\n'"$(cat compat.md)"'\n<!-- COMPAT_TABLE_END -->' README.md

      - name: Commit README
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "Update Java/Build tool compatibility table [skip ci]" || echo "No changes"
          git push
